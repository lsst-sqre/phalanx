nightlydigest-nginx:
  image:
    repository: nginx
    tag: 1.25.1
    pullPolicy: Always
  ingress:
    httpPath: /nightlydigest
    annotations:
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
  initContainers:
    frontend:
      image:
        repository: ts-dockerhub.lsst.org/nightlydigest-frontend
        tag: c0042.009
        pullPolicy: Always
  staticStore:
    name: nightlydigest-nginx-static
    storageClass: rook-ceph-block
    accessMode: ReadWriteOnce
    claimSize: 2Gi
    subPath: nightlydigest
  resources:
    requests:
      cpu: 50m
      memory: 70Mi
    limits:
      cpu: 500m
      memory: 300Mi
  nginxConfig: |
    server {
      listen 80;
      server_name localhost;
      location /nightlydigest {
        root /usr/src;
        try_files $uri$args $uri$args/ $uri/ /nightlydigest/index.html;
      }

      location /nightlydigest/api/ {
        proxy_pass http://nightlydigest-backend-service:8080/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
        proxy_redirect off;
      }
    }

nightlydigest-backend:
  replicas: 4
  image:
    repository: ts-dockerhub.lsst.org/nightlydigest-backend
    tag: c0042.009
    pullPolicy: Always
  env:
    - name: JIRA_API_HOSTNAME
      value: rubinobs.atlassian.net
    - name: EXTERNAL_INSTANCE_URL
      value: https://summit-lsp.lsst.codes
    - name: RUBIN_SIM_DATA_DIR
      value: &rsd /project/scheduler
    - name: AWS_SHARED_CREDENTIALS_FILE
      value: /etc/secrets/aws-credentials-butler.ini
    - name: S3_ENDPOINT_URL
      value: https://s3.cp.lsst.org
    - name: LSST_DISABLE_BUCKET_VALIDATION
      value: "1"
    - name: SIMS_SKYBRIGHTNESS_DATA
      value: /project/scheduler/skybrightness_pre_full
  envSecrets:
    - name: JIRA_API_TOKEN
      secretName: nightlydigest
      secretKey: jira-api-token
    - name: ACCESS_TOKEN
      secretName: nightlydigest-backend-gafaelfawr-token
      secretKey: token
  nfsMountpoints:
    - name: project-shared
      mountPath: *rsd
      readOnly: true
      server: nfs-project.cp.lsst.org
      serverPath: *rsd
  resources:
    requests:
      cpu: 150m
      memory: 3Gi
    limits:
      cpu: 1000m
      memory: 10Gi
