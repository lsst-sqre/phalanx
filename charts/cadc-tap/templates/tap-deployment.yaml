apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ template "cadc-tap.fullname" . }}
  labels:
    {{- include "cadc-tap.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      {{- include "cadc-tap.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: "server"
  template:
    metadata:
      {{- with .Values.podAnnotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      labels:
        {{- include "cadc-tap.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: "server"
    spec:
      {{- if .Values.cloudsql.enabled }}
      serviceAccountName: {{ .Values.serviceAccount.name }}
      {{- else }}
      automountServiceAccountToken: false
      {{- end }}
      containers:
        {{- if .Values.cloudsql.enabled }}
        - name: "cloud-sql-proxy"
          command:
            - "/cloud_sql_proxy"
            - "-ip_address_types=PRIVATE"
            - "-log_debug_stdout=true"
            - "-structured_logs=true"
            - "-instances={{ required "cloudsql.instanceConnectionName must be specified" .Values.cloudsql.instanceConnectionName }}=tcp:5432"
          image: "{{ .Values.cloudsql.image.repository }}:{{ .Values.cloudsql.image.tag }}"
          imagePullPolicy: {{ .Values.cloudsql.image.pullPolicy | quote }}
          {{- with .Values.cloudsql.resources }}
          resources:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - "all"
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 65532
            runAsGroup: 65532
        {{- end }}
        - name: "tap-server"
          {{- if eq .Values.config.backend "pg" }}
          image: "{{ .Values.config.pg.image.repository }}:{{ .Values.config.pg.image.tag }}"
          imagePullPolicy: {{ .Values.config.pg.image.pullPolicy | quote }}
          {{- end }}
          {{- if eq .Values.config.backend "qserv" }}
          image: "{{ .Values.config.qserv.image.repository }}:{{ .Values.config.qserv.image.tag }}"
          imagePullPolicy: {{ .Values.config.qserv.image.pullPolicy | quote }}
          {{- end }}
          env:
            - name: CATALINA_OPTS
              value: >-
                -Dtapschemauser.username=TAP_SCHEMA
                -Dtapschemauser.password=TAP_SCHEMA
                -Dtapschemauser.driverClassName=com.mysql.cj.jdbc.Driver
                -Dtapschemauser.url=jdbc:mysql://{{ .Values.config.tapSchemaAddress }}/
                -Dtapschemauser.maxActive=100
                -Duws.driverClassName=org.postgresql.Driver
                -Duws.maxActive=100
                {{- if .Values.cloudsql.enabled }}
                -Duws.password=$UWS_DB_PASSWORD
                -Duws.username={{ required "cloudsql.database must be specified" .Values.cloudsql.database }}
                -Duws.url=jdbc:postgresql://localhost:5432/{{ .Values.cloudsql.database }}
                {{- else }}
                -Duws.username=postgres
                -Duws.url=jdbc:postgresql://{{ template "cadc-tap.fullname" . }}-uws-db/
                {{- end }}
                {{- if eq .Values.config.backend "pg" }}
                -Dtap.username={{ .Values.config.pg.username }}
                -Dtap.password=$TAP_DB_PASSWORD
                -Dtap.url=jdbc:postgresql://{{ .Values.config.pg.host }}/{{ .Values.config.pg.database }}
                -Dtap.maxActive=100
                -Dca.nrc.cadc.auth.Authenticator=ca.nrc.cadc.sample.AuthenticatorImpl
                {{- end }}
                {{- if eq .Values.config.backend "qserv" }}
                -Dqservuser.username=qsmaster
                -Dqservuser.password=
                -Dqservuser.driverClassName=com.mysql.cj.jdbc.Driver
                -Dqservuser.url=jdbc:mysql://{{ .Values.config.qserv.host }}/{{ .Values.config.qserv.jdbcParams }}
                -Dqservuser.maxActive=100
                -Dca.nrc.cadc.auth.Authenticator=org.opencadc.tap.impl.AuthenticatorImpl
                {{- end }}
                -Dca.nrc.cadc.reg.client.RegistryClient.local=true
                -Dgafaelfawr_url={{ .Values.global.baseUrl }}/auth/api/v1/user-info
                -Dgcs_bucket={{ .Values.config.gcsBucket }}
                -Dgcs_bucket_url={{ .Values.config.gcsBucketUrl }}
                -Dgcs_bucket_type={{ .Values.config.gcsBucketType }}
                -Dbase_url={{ .Values.global.baseUrl }}
                -Dca.nrc.cadc.util.PropertiesReader.dir=/etc/creds/
                -Xmx{{ .Values.config.jvmMaxHeapSize }}
            {{- if eq .Values.config.backend "pg" }}
            - name: "TAP_DB_PASSWORD"
              valueFrom:
                secretKeyRef:
                  name: "cadc-tap"
                  key: "pgpassword"
            {{- end }}
            {{- if .Values.cloudsql.enabled }}
            - name: "UWS_DB_PASSWORD"
              valueFrom:
                secretKeyRef:
                  name: "cadc-tap"
                  key: "uws-db-password"
            {{- end }}
            - name: GOOGLE_APPLICATION_CREDENTIALS
              value: "/etc/creds/google_creds.json"
            {{- if eq .Values.config.gcsBucketType "S3" }}
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: cadc-tap
                  key: "AWS_SECRET_ACCESS_KEY"
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: cadc-tap
                  key: "AWS_ACCESS_KEY_ID"
            {{- end }}
            - name: DATALINK_PAYLOAD_URL
              value: "{{ .Values.config.datalinkPayloadUrl }}"
          ports:
            - containerPort: 8080
          {{- with .Values.resources }}
          resources:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          volumeMounts:
            - name: "google-creds"
              mountPath: "/etc/creds"
              readOnly: true
            - name: "tmp"
              mountPath: "/tmp"
          livenessProbe:
            failureThreshold: 3
            httpGet:
              path: /tap/availability
              port: 8080
              scheme: HTTP
            initialDelaySeconds: 10
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 1
      volumes:
        - name: "google-creds"
          secret:
            secretName: "cadc-tap"
        - name: "tmp"
          emptyDir: {}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
