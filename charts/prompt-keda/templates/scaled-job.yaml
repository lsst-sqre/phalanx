apiVersion: keda.sh/v1alpha1
kind: ScaledJob
metadata:
  name: {{ include "prompt-keda.fullname" . }}
  annotations:
    argocd.argoproj.io/hook: PostSync
  labels:
    instrument: {{ .Values.instrument.name | lower }}
spec:
  jobTargetRef:
    parallelism: 1
    completions: 1
    backoffLimit: 0
    template:
      metadata:
      {{- with .Values.podAnnotations }}
        annotations:
          {{- toYaml . | nindent 10 }}
      {{- end }}
      spec:
        initContainers:
          {{ include "prompt-keda.dbauth-initcontainer" . | indent 10}}
        restartPolicy: Never
        containers:
          - name: {{ include "prompt-keda.fullname" . | trimPrefix "prompt-keda-" }}
            image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
            imagePullPolicy: {{ .Values.image.pullPolicy | quote }}
            command:
              - /bin/sh
              - -c
              - |
                source /opt/lsst/software/stack/loadLSST.bash
                setup lsst_distrib
                python3 -m activator.activator
            env:
              - name: PLATFORM
                value: keda
              - name: WORKER_RESTART_FREQ
                value: {{ .Values.worker.restart | toString | quote }}
              - name: RUBIN_INSTRUMENT
                value: {{ .Values.instrument.name }}
              - name: PREPROCESSING_PIPELINES_CONFIG
                value: |-
                  {{- .Values.instrument.pipelines.preprocessing | nindent 18 }}
              - name: MAIN_PIPELINES_CONFIG
                value: |-
                  {{- .Values.instrument.pipelines.main | nindent 18 }}
              - name: SKYMAP
                value: {{ .Values.instrument.skymap }}
              - name: MESSAGE_EXPIRATION
                value: {{ .Values.keda.redisStreams.expiration | toString | quote }}
              - name: PRELOAD_PADDING
                value: {{ .Values.instrument.preloadPadding | toString | quote }}
              - name: EXPORT_TYPE_REGEXP
                value: {{- toYaml .Values.instrument.exportTypes | nindent 18 }}
              - name: IMAGE_BUCKET
                value: {{ .Values.s3.imageBucket }}
              - name: BUCKET_TOPIC
                value: {{ .Values.imageNotifications.topic }}
              - name: BUCKET_NOTIFICATION_KAFKA_OFFSET_RESET
                value: {{ .Values.imageNotifications.consumerOffsetReset }}
              - name: IMAGE_TIMEOUT
                value: {{ .Values.imageNotifications.imageTimeout | toString | quote }}
              - name: CENTRAL_REPO
                value: {{ .Values.instrument.centralRepo }}
              {{- with .Values.instrument.readRepo }}
              - name: READ_CENTRAL_REPO
                value: {{ . }}
              {{- end }}
              - name: REPO_RETRY_DELAY
                value: {{ .Values.instrument.repoWait | toString | quote }}
              - name: LSST_DISABLE_BUCKET_VALIDATION
                value: {{ .Values.s3.disableBucketValidation | toString | quote }}
              - name: CONFIG_APDB
                value: {{ .Values.apdb.config }}
              - name: KAFKA_CLUSTER
                value: {{ .Values.imageNotifications.kafkaClusterAddress }}
              - name: RAW_MICROSERVICE
                value: {{ .Values.raw_microservice }}
              # MpSkyEphemerisQuery handles MP_SKY_URL being unset, but not empty
              {{- with .Values.mpSky_service }}
              - name: MP_SKY_URL
                value: {{ . }}
              {{- end }}
              {{- with .Values.iers_cache }}
              - name: CENTRAL_IERS_CACHE
                value: {{ . }}
              {{- end }}
              - name: SASQUATCH_URL
                value: {{ .Values.sasquatch.endpointUrl }}
              {{- if and .Values.sasquatch.endpointUrl .Values.sasquatch.auth_env }}
              - name: SASQUATCH_TOKEN
                valueFrom:
                  secretKeyRef:
                    name: {{ template "prompt-keda.fullname" . }}-secret
                    key: sasquatch_token
              {{- end }}
              - name: DAF_BUTLER_SASQUATCH_NAMESPACE
                value: {{ .Values.sasquatch.namespace }}
              {{ include "prompt-keda.butler-env" . | indent 12}}
              - name: AP_KAFKA_PRODUCER_PASSWORD
                valueFrom:
                  secretKeyRef:
                    name: {{ template "prompt-keda.fullname" . }}-secret
                    key: alert_stream_pass
              - name: AP_KAFKA_PRODUCER_USERNAME
                value: {{ .Values.alerts.username}}
              - name: AP_KAFKA_SERVER
                value: {{ .Values.alerts.server}}
              - name: AP_KAFKA_TOPIC
                value: {{ .Values.alerts.topic}}
              - name: LOCAL_REPOS
                value: /tmp-butler
              - name: SERVICE_LOG_LEVELS
                value: {{ .Values.logLevel }}
              - name: LOCAL_REPO_CACHE_SIZE
                value: {{ .Values.cache.baseSize | toString | quote }}
              - name: REFCATS_PER_IMAGE
                value: {{ .Values.cache.refcatsPerImage | toString | quote }}
              - name: PATCHES_PER_IMAGE
                value: {{ .Values.cache.patchesPerImage | toString | quote }}
              - name: DEBUG_EXPORT_OUTPUTS
                value: {{ if .Values.debug.exportOutputs }}'1'{{ else }}'0'{{ end }}
              {{- if .Values.debug.monitorDaxApdb }}
              - name: DAX_APDB_MONITOR_CONFIG
                value: 'logging:lsst.dax.apdb.monitor'
              {{- end }}
              - name: REDIS_STREAM_HOST
                value: {{ .Values.keda.redisStreams.host}}
              - name: REDIS_STREAM_NAME
                value: {{ .Values.keda.redisStreams.streamName}}
              - name: REDIS_STREAM_CONSUMER_GROUP
                value: {{ .Values.keda.redisStreams.consumerGroup}}
              - name: REDIS_RETRY_DELAY
                value: {{ .Values.keda.redisStreams.retry | toString | quote }}
              - name: FANNED_OUT_MSG_LISTEN_TIMEOUT
                value: {{ .Values.keda.redisStreams.msgListenTimeout | toString | quote }}
            volumeMounts:
              - mountPath: /tmp-butler
                name: ephemeral
              {{ include "prompt-keda.butler-volumeMounts" . | indent 14}}
              {{- if .Values.registry.centralRepoFile }}
              - mountPath: {{ .Values.instrument.centralRepo }}
                name: central-repo-file
              {{- with .Values.instrument.readRepo }}
              - mountPath: {{ . }}
                name: read-repo-file
              {{- end }}
              {{- end }}
              {{- with .Values.additionalVolumeMounts }}
              {{- toYaml . | nindent 8 }}
              {{- end }}
            {{- with .Values.resources }}
            resources:
              {{- toYaml . | nindent 14 }}
            {{- end }}
        volumes:
          - name: ephemeral
            emptyDir:
              sizeLimit: {{ .Values.keda.ephemeralStorageLimit }}
          {{ include "prompt-keda.butler-volumes" . | indent 10}}
          {{- if .Values.registry.centralRepoFile }}
          - name: central-repo-file
            secret:
              secretName: {{ template "prompt-keda.fullname" . }}-secret
              items:
              - key: central_repo_file
                path: butler.yaml
          {{- if .Values.instrument.readRepo }}
          - name: read-repo-file
            secret:
              secretName: {{ template "prompt-keda.fullname" . }}-secret
              items:
              - key: read_repo_file
                path: butler.yaml
          {{- end }}
          {{- end }}
          {{- with .Values.tolerations }}
        tolerations:
          {{- toYaml . | nindent 12 }}
        {{- end }}
        {{- with .Values.affinity }}
        affinity:
          {{- toYaml . | nindent 12 }}
        {{- end }}
        {{- with .Values.nodeSelector }}
        nodeSelector:
          {{- toYaml . | nindent 12 }}
        {{- end }}
  pollingInterval: {{ .Values.keda.pollingInterval}}
  successfulJobsHistoryLimit: {{ .Values.keda.successfulJobsHistoryLimit}}
  failedJobsHistoryLimit: {{ .Values.keda.failedJobsHistoryLimit}}
  minReplicaCount: {{ .Values.keda.minReplicaCount}}
  maxReplicaCount: {{ .Values.keda.maxReplicaCount}}
  rollout:
    strategy: default
    propagationPolicy: foreground
  scalingStrategy:
    strategy: {{ .Values.keda.scalingStrategy}}
  triggers:
    - type: redis-streams
      metadata:
        host: {{ .Values.keda.redisStreams.host}}
        port: "6379"
        stream: {{ .Values.keda.redisStreams.streamName}}
        consumerGroup: {{ .Values.keda.redisStreams.consumerGroup}}
        activationLagCount: {{ .Values.keda.redisStreams.activationLagCount | toString | quote}}
        lagCount: {{ .Values.keda.redisStreams.lagCount| toString | quote}}
        pendingEntriesCount: {{ .Values.keda.redisStreams.pendingEntriesCount | toString | quote}}
